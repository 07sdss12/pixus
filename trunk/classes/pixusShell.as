// pixusShell class// The Application Root Class// (cc)2007-2010 JPEG Interactive// By Jam Zhang// jammind@gmail.compackage {	import flash.display.NativeWindow;	import flash.display.NativeWindowType;	import flash.display.NativeWindowInitOptions;	import flash.display.NativeWindowSystemChrome;	import flash.display.NativeMenu;	import flash.display.NativeMenuItem;	import flash.display.MovieClip;	import flash.display.Sprite;	import flash.display.SimpleButton;	import flash.display.StageAlign;	import flash.display.StageScaleMode;	import flash.desktop.DockIcon;	import flash.desktop.SystemTrayIcon;	import flash.desktop.NativeApplication;	import flash.net.URLLoader;	import flash.net.URLRequest;	import flash.net.SharedObject;	import flash.events.Event;	import flash.events.IOErrorEvent;	import flash.events.SecurityErrorEvent;	import flash.events.InvokeEvent;	import flash.events.MouseEvent;	import flash.events.ScreenMouseEvent;	import flash.geom.Point;	import flash.utils.ByteArray;	import flash.system.Capabilities;	import com.google.analytics.GATracker;	import caurina.transitions.Tweener;	import codeplay.event.customEvent;	import codeplay.utils.copyObjectDeep;	public class pixusShell extends Sprite {				public static const APP_NAME:String='Pixus';		public static const APP_PATH:String='/';		public static const UI_TWEENING_TIME:Number=.3;		public static const ROW_WIDTH:int=300;		public static const PRESET_ROW_HEIGHT:int=25;		public static const SKIN_ROW_HEIGHT:int=50;		public static const PIXUS_PANEL_X:int=400;		public static const PIXUS_PANEL_Y:int=200;		public static const UPDATE_PANEL_WIDTH:int=300;		public static const UPDATE_PANEL_CONTENT_HEIGHT:int=120;		public static const UPDATE_PANEL_X:int=50;		public static const UPDATE_PANEL_Y:int=50;		public static const PREFERENCES_PANEL_WIDTH:int=300;		public static const PREFERENCES_PANEL_X:int=50;		public static const PREFERENCES_PANEL_Y:int=320;		// Custom Events		public static const EVENT_TAB_ACTIVATED:String='PixusEventTabActivated'; // Preferences Tab Icon Clicked		public static const EVENT_SYNC_WINDOW_SIZE:String='PixusEventSyncWindowSize';		public static const EVENT_SYNC_MENU:String='PixusEventSyncMenu';// Sync System Tray / Dock Icon Menu To The Presets		public static const EVENT_SYNC_PRESETS:String='PixusEventSyncPresets';// Sync Preferences / Presets		public static const EVENT_APPLY_SKIN:String='PixusEventApplySkin';// Apply Skin		public static const EVENT_FIND_BACK:String='PixusEventFindPixusBack';// Apply Skin		public static const EVENT_RESET_PRESETS:String='PixusEventResetPresets';// Reset Preferences / Presets		public static const EVENT_PRESETS_CHANGE:String='PixusEventPresetsChange';// Presets Data Changed		public static const EVENT_CHECK_UPDATE:String='PixusEventCheckUpdate';// Check For Update		public static const EVENT_START_FREE_DRAG:String='PixusEventStartFreeDrag';// Start Multi-screen Drag		public static const SHOW_PREFERENCES:String='PixusEventShowPreferences';// Show Preferences Window		public static const HIDE_PREFERENCES:String='PixusEventHidePreferences';// Hide Preferences Window		public static const SHOW_PIXUS:String='PixusEventShowPixus';// Show Pixus Window		public static const HIDE_PIXUS:String='PixusEventHidePixus';// Hide Pixus Window		public static const TOGGLE_PIXUS:String='PixusEventTogglePixus';// Toggle Pixus Window		public static const SHOW_UPDATE:String='PixusEventShowUpdate';// Show Update Window		public static const HIDE_UPDATE:String='PixusEventHideUpdate';// Hide Update Window		public static const UPDATE_STATUS_CHANGE:String='PixusEventUpdateStatusChange';// When Update Status is Changed		public static const EVENT_TOGGLE_GUIDES:String='PixusEventToggleGuides';// Toggle Quick Guides		public static const SHOW_TITLE_BAR:String='PixusEventShowTitleBar';// Show Title Bar		public static const HIDE_TITLE_BAR:String='PixusEventHideTitleBar';// Hide Title Bar for Screen Shooting		public static const TOGGLE_TITLE_BAR:String='PixusEventToggleTitleBar';// Toggle Title Bar for Screen Shooting				// Update Status		public static const UPDATE_CHECKING:int=0;		public static const UPDATE_SUCCEEDED:int=1;		public static const UPDATE_FAILED:int=2;						// Defult Presets		public static const PRESETS:Array=[		{width:480,height:272,comments:'PSP'},		{width:480,height:320,comments:'iPhone Landscape'},		{width:320,height:480,comments:'iPhone Portrait'},		{width:640,height:480,comments:'VGA'},		{width:760,height:420,comments:'SVGA Windowed'},		{width:800,height:600,comments:'SVGA'},		{width:955,height:600,comments:'XGA Windowed'},		{width:1024,height:768,comments:'XGA'}		];		var mcPixus:pixus;		var windowPixus:hidingWindow;		var windowPreferences:NativeWindow=null;		var windowUpdate:NativeWindow=null;				public var updateInfo:XML=null;		public var updateStatus:int=UPDATE_CHECKING;		private var updateCheckLoader:URLLoader;		private var loader:URLLoader;		private var spritePreferences:preferences=null;		private var spriteUpdate:update=null;				static var firstTimeInvoke:Boolean=true;		public static var so:SharedObject=SharedObject.getLocal(APP_NAME,APP_PATH);		public static var skinpresets, settings:XML;		public static var options:Object=so.data;		public static var isMacOS:Boolean=(Capabilities.os.indexOf('Mac')!=-1);		// Creating a Google Analytics tracker		public static var tracker:GATracker;		// Must initialize SharedObject first for Max OS X compatibility. Never use SharedObject.getLocal(APP_NAME,APP_PATH).data directly.		function pixusShell():void {						// Default settings			if (options.presets==undefined) {				options.presets=PRESETS;			}			if (options.alwaysInFront==undefined) {				options.alwaysInFront=true;			}			if (options.showQuickGuides==undefined) {				options.showQuickGuides=true;			}			if (options.QuickQuides==undefined) {				options.QuickQuides=[{type:'H',offsetY:20},{type:'V',offsetX:20}];			}						// Pixus window default settings			if (pixusShell.options.pixusWindow==undefined) {				pixusShell.options.pixusWindow={x:120,y:80,width:640,height:480,visible:true};			}			if (pixusShell.options.pixusWindow.width==undefined) {				pixusShell.options.pixusWindow.width=640;			}			if (pixusShell.options.pixusWindow.height==undefined) {				pixusShell.options.pixusWindow.height=480;			}						if (pixusShell.options.pixusWindow.x==undefined) {				pixusShell.options.pixusWindow.x=120;			}			if (pixusShell.options.pixusWindow.y==undefined) {				pixusShell.options.pixusWindow.y=80;			}						if (pixusShell.options.pixusWindow.visible==undefined) {				pixusShell.options.pixusWindow.visible=true;			}			if (pixusShell.options.pixusWindow.overlayMode==undefined) {				pixusShell.options.pixusWindow.overlayMode=false;			}						// Preferences window default settings			if (pixusShell.options.preferencesWindow==undefined) {				pixusShell.options.preferencesWindow={x:pixusShell.PREFERENCES_PANEL_X,y:pixusShell.PREFERENCES_PANEL_Y,height:600,visible:true};			}						// Update window default settings			if (options.updateWindow==undefined) {				options.updateWindow={x:100,y:100,visible:false};			}			if (options.updateWindow.x==undefined) {				options.updateWindow.x=100;			}			if (options.updateWindow.y==undefined) {				options.updateWindow.y=100;			}			if (options.updateWindow.visible==undefined) {				options.updateWindow.visible=false;			}						addEventListener(Event.ADDED_TO_STAGE,init);		}		function init(e:Event):void{			// Creating a Google Analytics tracker object and track the launch			tracker = new GATracker( this, 'UA-1806074-16', 'AS3', false );						loader=new URLLoader();			loader.addEventListener(Event.COMPLETE,parseXML);			loader.addEventListener(IOErrorEvent.IO_ERROR,errorXML);			loader.addEventListener(SecurityErrorEvent.SECURITY_ERROR,errorXML);			loader.load(new URLRequest('pixus-settings.xml'));		}		function errorXML(e:Event):void{						switch(e.type){				case IOErrorEvent.IO_ERROR:					tracker.trackPageview( 'Launch/Failed/IO_ERROR');					tracker.trackEvent('Launch', 'Failure', 'IO_ERROR', 0);					break;				case SecurityErrorEvent.SECURITY_ERROR:					tracker.trackPageview( 'Launch/Failed/SECURITY_ERROR');					tracker.trackEvent('Launch', 'Failure', 'SECURITY_ERROR', 0);					break;			}						loader=null;					}		function parseXML(e:Event):void {			settings=new XML(e.target.data);			skinpresets=settings.skinpresets;			if (options.skin==undefined) {				options.skin=0;			}			options.updateFeedURL=settings.updatefeedurl;			options.version=settings.version;			tracker.trackPageview( 'Launch/R'+options.version.release);			tracker.trackEvent('Launch', 'Successfully', 'Release', options.version.release);			// Create Pixus Window			var option:NativeWindowInitOptions;			option=new NativeWindowInitOptions();			option.type=NativeWindowType.UTILITY ;			option.systemChrome=NativeWindowSystemChrome.NONE;			option.transparent=true;			windowPixus=new hidingWindow(option);			windowPixus.title = 'Pixus';			mcPixus=new pixus(this);			windowPixus.stage.addChild(mcPixus);			//Create Preferences Window			togglePreferencesWindow(options.preferencesWindow.visible);			//Create Update Window			toggleUpdateWindow(options.updateWindow.visible);			// Set Always In Front State			alwaysInFront=pixusShell.options.alwaysInFront;			// Dock and SystemTray Icon			syncMenu();			NativeApplication.nativeApplication.icon.addEventListener(MouseEvent.CLICK,handleIcon);// For Windows Tray Icon			NativeApplication.nativeApplication.addEventListener(InvokeEvent.INVOKE,handleInvoke);// For Mac OS Dock Icon Click or Reinvoke in Windows			NativeApplication.nativeApplication.icon.bitmaps  = [			new BitmapIconPixus512(512,512),			new BitmapIconPixus128(128,128),			new BitmapIconPixus48(48,48),			new BitmapIconPixus32(32,32),			new BitmapIconPixus16(16,16)			];			// Windows System Tray			if (NativeApplication.supportsSystemTrayIcon) {				var sysTrayIcon:SystemTrayIcon=NativeApplication.nativeApplication.icon as SystemTrayIcon;				sysTrayIcon.tooltip = APP_NAME;			}			// Max OSX Dock Bar			//if (NativeApplication.supportsDockIcon) {			//var dockIcon:DockIcon=NativeApplication.nativeApplication.icon as DockIcon;			//}			NativeApplication.nativeApplication.addEventListener(Event.ACTIVATE, handleFocus);			NativeApplication.nativeApplication.addEventListener(Event.DEACTIVATE, handleFocus);			NativeApplication.nativeApplication.addEventListener(EVENT_SYNC_MENU, handleSyncMenu);			NativeApplication.nativeApplication.addEventListener(SHOW_PREFERENCES, handleWindows);			NativeApplication.nativeApplication.addEventListener(HIDE_PREFERENCES, handleWindows);			NativeApplication.nativeApplication.addEventListener(SHOW_PIXUS, handleWindows);			NativeApplication.nativeApplication.addEventListener(HIDE_PIXUS, handleWindows);			NativeApplication.nativeApplication.addEventListener(TOGGLE_PIXUS, handleWindows);			NativeApplication.nativeApplication.addEventListener(SHOW_UPDATE, handleUpdate);			NativeApplication.nativeApplication.addEventListener(HIDE_UPDATE, handleUpdate);			NativeApplication.nativeApplication.addEventListener(EVENT_FIND_BACK,handleFindBackEvent);			NativeApplication.nativeApplication.addEventListener(EVENT_RESET_PRESETS,doResetPresets);						loader=null;			checkUpdate();		}		public function set alwaysInFront(t:Boolean){			options.alwaysInFront=t;			if (windowPreferences!=null) {				windowPreferences.alwaysInFront=t;			}			if (windowUpdate!=null) {				windowUpdate.alwaysInFront=t;			}			windowPixus.alwaysInFront=t;		}		public function get freeDragging():Boolean{			return mcPixus.main.freeDragging;		}		public function stopFreeDrag():void{			mcPixus.main.stopFreeDrag();		}		function handleWindows(event:Event):void {			switch(event.type){				case SHOW_PREFERENCES:					togglePreferencesWindow(true);					break;				case HIDE_PREFERENCES:					togglePreferencesWindow(false);					break;				case SHOW_PREFERENCES:					togglePreferencesWindow(true);					break;				case SHOW_PIXUS:					togglePixusWindow(true);					break;				case HIDE_PIXUS:					togglePixusWindow(false);					break;				case TOGGLE_PIXUS:					togglePixusWindow();					break;			}		}		function syncMenu():void {			var iconMenu:NativeMenu = new NativeMenu();			var item:NativeMenuItem;						// Adding Presets			for (var n=0; n<options.presets.length; n++) {				var preset=options.presets[n];				item=new NativeMenuItem(preset.width+' x '+preset.height+' '+preset.comments);				item.data=preset;				item.addEventListener(Event.SELECT,handlePresets);				iconMenu.addItem(item);			}						// Adding Separator			iconMenu.addItem(new NativeMenuItem('',true));						// Adding Skins			for (n=0; n<skinpresets.skin.length(); n++) {				var skin:XML=skinpresets.skin[n];				skin.@id=n;				//trace(skin);				item=new NativeMenuItem(skin.@title+' ('+skin.@subtitle+')');				item.data=skin;				item.addEventListener(Event.SELECT,handleSkins);				iconMenu.addItem(item);			}						// Adding Separator			iconMenu.addItem(new NativeMenuItem('',true));						item=new NativeMenuItem('Find Panels');			item.addEventListener(Event.SELECT,handleFindBack);			item.mnemonicIndex=0;//			item.keyEquivalent='f';			iconMenu.addItem(item);			item=new NativeMenuItem('Preferences');			item.addEventListener(Event.SELECT,handlePreferences);			item.mnemonicIndex=0;//			item.keyEquivalent='k';			iconMenu.addItem(item);			item=new NativeMenuItem('Update');			item.addEventListener(Event.SELECT,handleUpdate);			item.mnemonicIndex=0;//			item.keyEquivalent='u';			iconMenu.addItem(item);			item=new NativeMenuItem('Exit');			item.addEventListener(Event.SELECT,handleExit);			item.mnemonicIndex=1;//			item.keyEquivalent='q';			iconMenu.addItem(item);			var sysTrayIcon=NativeApplication.nativeApplication.icon;			sysTrayIcon.menu = mcPixus.main.dragger.contextMenu = iconMenu;		}		function handleSyncMenu(event:Event):void {			syncMenu();		}		function handlePresets(event:Event):void {			var data:Object=(event.target as NativeMenuItem).data;			NativeApplication.nativeApplication.dispatchEvent(new customEvent(customEvent.SET_WINDOW_SIZE,data));			tracker.trackPageview('TrayMenu/Presets/Apply/'+data.width+'_'+data.height);		}		function handleSkins(event:Event):void {			var data:Object=(event.target as NativeMenuItem).data;			pixusShell.options.skin=int(data.@id);			NativeApplication.nativeApplication.dispatchEvent(new Event(pixusShell.EVENT_APPLY_SKIN));			tracker.trackPageview('TrayMenu/Skins/Apply/'+data.@title);		}		// Toggle Pixus		function handleIcon(event:Event):void {			tracker.trackPageview('TrayIcon/'+(windowPixus.visible?'Hide':'Show'));			togglePixusWindow();		}		// Show Pixus when invoking		// Strange in Windows, even running for the 1st time will dispatch INVOKE		// Stop from always showing Pixus when launching		function handleInvoke(event:Event):void {			if(firstTimeInvoke)				firstTimeInvoke=false;			else				if(isMacOS)					togglePixusWindow(); // Toggle visibility when clicking the dock icon under Mac OS X				else					togglePixusWindow(true); // Always show it when launching again under Windows		}				function handleFocus(event:Event):void {			switch(event.type) {				case Event.ACTIVATE:					showWindows();					break;				case Event.DEACTIVATE:					hideWindows(false);					break;			}		}				function showWindows():void {			if(windowPixus) {				windowPixus.visible=true;			}			if(windowPreferences) {				windowPreferences.visible=true;			}			if(windowUpdate) {				windowUpdate.visible=true;			}			windowPixus.orderToFront();		}					function hideWindows(hidePixusWindow:Boolean=true):void {			if(hidePixusWindow&&windowPixus) {				windowPixus.visible=false;			}			if(windowPreferences) {				windowPreferences.visible=false;			}			if(windowUpdate) {				windowUpdate.visible=false;			}		}					function handleFindBack(event:Event):void { // Invoked from sys tray / dock menu			tracker.trackPageview('TrayMenu/FindBack');			// Strange! handleFindBackEvent accepts an Event parameter but I have to trigger a customEvent or I will get a runtime error.			NativeApplication.nativeApplication.dispatchEvent(new customEvent(EVENT_FIND_BACK));		}		// pixusShell handle finding back of the preferences window		function handleFindBackEvent(event:Event):void { // Real find panels codes			togglePixusWindow(true);			togglePreferencesWindow(true);			toggleUpdateWindow(true);			// Find Preferences window			options.preferencesWindow.x=PREFERENCES_PANEL_X;			options.preferencesWindow.y=PREFERENCES_PANEL_Y;			Tweener.addTween(windowPreferences,{x:options.preferencesWindow.x,time:pixusShell.UI_TWEENING_TIME,transition:'easeOutCubic'});			Tweener.addTween(windowPreferences,{y:options.preferencesWindow.y,time:pixusShell.UI_TWEENING_TIME,transition:'easeOutCubic'});			// Find Update window			options.updateWindow.x=UPDATE_PANEL_X;			options.updateWindow.y=UPDATE_PANEL_Y;			Tweener.addTween(windowUpdate,{x:options.updateWindow.x,time:pixusShell.UI_TWEENING_TIME,transition:'easeOutCubic'});			Tweener.addTween(windowUpdate,{y:options.updateWindow.y,time:pixusShell.UI_TWEENING_TIME,transition:'easeOutCubic'});		}		function doResetPresets(event:Event):void {			pixusShell.options.presets=copyObjectDeep(pixusShell.PRESETS);			NativeApplication.nativeApplication.dispatchEvent(new Event(EVENT_PRESETS_CHANGE));		}		function handleExit(event:Event):void {			tracker.trackPageview( 'TrayMenu/Exit');			NativeApplication.nativeApplication.exit();		}		function handlePreferences(event:Event):void {			tracker.trackPageview( 'TrayMenu/Preferences');			togglePreferencesWindow(true);		}		function handleUpdate(event:Event):void {			trace('pixusShell.handleUpdate('+event.type+')');			switch (event.type) {				case SHOW_UPDATE:					toggleUpdateWindow(true);					break;				case HIDE_UPDATE:					toggleUpdateWindow(false);					break;				case Event.SELECT:					tracker.trackPageview('TrayMenu/Update');					toggleUpdateWindow(true);					break;			}		}						// Update Logic				public function checkUpdate():void {			updateStatus=UPDATE_CHECKING;			updateCheckLoader=new URLLoader();			updateCheckLoader.addEventListener(Event.COMPLETE,handleUpdateChecked);			updateCheckLoader.addEventListener(IOErrorEvent.IO_ERROR,handleUpdateChecked);			updateCheckLoader.addEventListener(SecurityErrorEvent.SECURITY_ERROR,handleUpdateChecked);			updateCheckLoader.load(new URLRequest(pixusShell.options.updateFeedURL));			NativeApplication.nativeApplication.dispatchEvent(new Event(UPDATE_STATUS_CHANGE));		}				function handleUpdateChecked(event:Event):void {						updateCheckLoader.removeEventListener(Event.COMPLETE,handleUpdateChecked);			updateCheckLoader.removeEventListener(IOErrorEvent.IO_ERROR,handleUpdateChecked);			updateCheckLoader.removeEventListener(SecurityErrorEvent.SECURITY_ERROR,handleUpdateChecked);			updateCheckLoader=null;						switch(event.type){								case Event.COMPLETE: // Update feed XML successfully loaded									tracker.trackPageview( 'Update/Check/Succeeded');					updateStatus=UPDATE_SUCCEEDED;					updateInfo=new XML(event.target.data);					NativeApplication.nativeApplication.dispatchEvent(new Event(UPDATE_STATUS_CHANGE));					if(int(options.version.release)<int(updateInfo.latest.release)) {						toggleUpdateWindow(true);					}					break;									default:									tracker.trackPageview( 'Update/Check/Failed');					updateStatus=UPDATE_FAILED;					NativeApplication.nativeApplication.dispatchEvent(new Event(UPDATE_STATUS_CHANGE));					break;								}		}						// UI Toggling Logix				public function togglePixusWindow(v:Object=null):void{						NativeApplication.nativeApplication.dispatchEvent(new Event(pixusShell.SHOW_TITLE_BAR));						if(v==null) {				v=!pixusShell.options.pixusWindow.visible;			}						windowPixus.visible=pixusShell.options.pixusWindow.visible=v;			if(v) {				windowPixus.orderToFront();			}		}		public function togglePreferencesWindow(v:Object=null):void{			if(v==null) {				v=!pixusShell.options.preferencesWindow.visible;			}			pixusShell.options.preferencesWindow.visible=v;						if(v) {				if (windowPreferences==null) {					// Create a new window					var option:NativeWindowInitOptions=new NativeWindowInitOptions();					option.type=NativeWindowType.UTILITY;					option.systemChrome=NativeWindowSystemChrome.NONE;					option.transparent=true;					windowPreferences=new NativeWindow(option);					windowPreferences.alwaysInFront=options.alwaysInFront;					if (options.preferencesWindow==undefined) {						options.preferencesWindow={x:100,y:300,height:600};					}					if (options.preferencesWindow!=undefined) {						windowPreferences.x=options.preferencesWindow.x;						windowPreferences.y=options.preferencesWindow.y;					}							windowPreferences.title = 'Pixus Preferences';					windowPreferences.width = PREFERENCES_PANEL_WIDTH+100;					windowPreferences.stage.scaleMode=StageScaleMode.NO_SCALE;					windowPreferences.stage.align=StageAlign.TOP_LEFT;					spritePreferences=new preferences(this);					spritePreferences.x=10;					spritePreferences.y=10;					windowPreferences.stage.addChild(spritePreferences);				} else {					// Bring existing window to front					windowPreferences.visible=true;					windowPreferences.orderToFront();				}			} else if (windowPreferences!=null) {				windowPreferences.stage.removeChild(spritePreferences);				spritePreferences=null;				windowPreferences.close();				windowPreferences=null;			}		}		public function toggleUpdateWindow(v:Object=null):void{			if(v==null) {				v=!options.updateWindow.visible;			}						options.updateWindow.visible=v;						if(v) {				if (windowUpdate==null) {					// Create a new window					var option:NativeWindowInitOptions=new NativeWindowInitOptions();					option.type=NativeWindowType.UTILITY ;					option.systemChrome=NativeWindowSystemChrome.NONE;					option.transparent=true;					windowUpdate=new NativeWindow(option);					windowUpdate.alwaysInFront=options.alwaysInFront;					windowUpdate.width=350;					windowUpdate.height=300;					spriteUpdate=new update(this);					if (pixusShell.options.updateWindow.x!=undefined) {						spriteUpdate.x=options.updateWindow.x;					}					if (pixusShell.options.updateWindow.y!=undefined) {						spriteUpdate.y=options.updateWindow.y;					}					windowUpdate.stage.addChild(spriteUpdate);					windowUpdate.visible=true;				} else {					windowUpdate.visible=true;					windowUpdate.orderToFront();				}			} else if (windowUpdate!=null) {				windowUpdate.stage.removeChild(spriteUpdate);				spriteUpdate=null;				windowUpdate.close();				windowUpdate=null;			}		}		public function getSkin(id:int=-1):XML {			if(id<0)				id=options.skin;			return skinpresets.skin[id];		}	}}